<!DOCTYPE html>
<head>    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script>L_PREFER_CANVAS=false; L_NO_TOUCH=false; L_DISABLE_3D=false;</script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-search@2.9.8/src/leaflet-search.js" integrity="sha256-qGIpIMlQBXdYwk0c6btx1RD6z3EJX5Y685QoJrMS2sE=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.3.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@2.9.8/src/leaflet-search.css" integrity="sha256-shglAIJTG86aSEHQg3eLxymTGG0nMyMRXBwGplGN1jU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://rawcdn.githack.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css"/>
    
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    
    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>#map {
        position: relative;
        width: 100.0%;
        height: 100.0%;
        left: 0.0%;
        top: 0.0%;
        }
    </style>
</head>
<body>    
    
    <div class="folium-map" id="map" ></div>
</body>
<script>    
    
    var bounds = null;
    
    var map = L.map(
        'map', {
        center: {{latlong}}, //[41.6655, -73.9043],
        zoom: 12,
        maxBounds: bounds,
        layers: [],
        worldCopyJump: false,
        crs: L.CRS.EPSG3857,
        zoomControl: true,
        });

    
    var tile_layer = L.tileLayer(
        'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg',
        {
        "attribution": null,
        "detectRetina": false,
        "maxNativeZoom": 18,
        "maxZoom": 18,
        "minZoom": 0,
        "noWrap": false,
        "opacity": 1,
        "subdomains": "abc",
        "tms": false
        }).addTo(map);
        
    var nodeMarkerOptions = {
        radius: 4,
        fillColor: "#ff7800",
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    };
        
    var linkStyle = {
        'bubblingMouseEvents': true,
        'fillOpacity': 0.8,
        'weight': 2,
        'color': 'black',
        'fillColor': 'black'
    };    
    
    var wnnodes = {{nodes_geojson}}
    var geojsonNodeLayer = L.geoJson(wnnodes, {
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, nodeMarkerOptions);
        }
    }).addTo(map);
    
    geojsonNodeLayer.bindTooltip(
        function(layer){
        // Convert non-primitive to String.
        let handleObject = (feature)=>typeof(feature)=='object' ? JSON.stringify(feature) : feature;
        let fields = ['ID', 'Base Demand (gpm)'];
            
        return '<table>' +
        String(
            fields.map(
            columnname=>
                `<tr style="text-align: left;">
                <th style="padding: 4px; padding-right: 10px;">
                ${ columnname}
                </th>
                    
            <td style="padding: 4px;">${handleObject(layer.feature.properties[columnname])
                }</td></tr>`
            ).join(''))
            +'</table>'
        }, {"sticky": true});
            
    var wnlinks = {{links_geojson}}
    
    var geoJsonLinkLayer = L.geoJson(wnlinks, {
        style : function (feature) {
            return linkStyle;
        }
    }).addTo(map);
    
    geoJsonLinkLayer.bindTooltip(
        function(layer){
        // Convert non-primitive to String.
        let handleObject = (feature)=>typeof(feature)=='object' ? JSON.stringify(feature) : feature;
        let fields = ['ID', 'Pipe Diameter (in)'];
            
        return '<table>' +
        String(
            fields.map(
            columnname=>
                `<tr style="text-align: left;">
                <th style="padding: 4px; padding-right: 10px;">
                ${ columnname}
                </th>
                    
                <td style="padding: 4px;">${handleObject(layer.feature.properties[columnname])
                }</td></tr>`
            ).join(''))
            +'</table>'
        }, {"sticky": true});    
    
    var networkLayers = L.layerGroup([geojsonNodeLayer, geoJsonLinkLayer]);   
                
    L.control.search({
        layer: networkLayers,
        initial: true,
        propertyName: 'ID',
        moveToLocation: function(latlng, title, map) {
            var zoom = 16;
            map.setView(latlng, zoom); // access the zoom
            },
        hideMarkerOnCollapse: true
    }).addTo(map);    
            
    var layer_control = {
        base_layers : {
            "Nodes": wnnodes,
            "Links": wnlinks
        }
    };            
        
    L.control.layers(
        layer_control.base_layers,
        null,
        {position: 'bottomleft',
         collapsed: false,
         autoZIndex: true
        }
    ).addTo(map);
    
    L.control.scale({position:'topright'}).addTo(map);
                
</script>